# 团队合作原则
本章介绍团队合作原则。 描述了以下原则：

- 使用敏捷框架原则
- 定义完成原则
- 你为别人写代码的原则
- 避免技术债原则
- 软件组件文档原则
- 代码审查原则
- 统一代码格式化原则
- 高并发开发原则
- 结对编程原则
- 明确定义的开发团队角色原则

## 使用敏捷框架原则

> 使用敏捷框架可以为组织带来许多好处，包括提高生产力、改进质量、加快上市时间和提高员工满意度。

以上说法来自一些采用了[Scaled Agile Framework (SAFe)](https://www.scaledagileframework.com/)的公司的[客户案例](https://scaledagile.com/insights-customer-stories/)。

敏捷框架描述了一种标准化的软件开发方式，这是必不可少的，尤其是在大型组织中。 在当今的工作环境中，人们经常更换工作，团队也往往经常更换，这可能导致一种情况，除非使用特定的敏捷框架，否则对工作方式没有共同的理解。 敏捷框架建立了明确的职责分工，每个人都可以专注于自己最擅长的事情。

例如，在 ```SAFe``` 中，在程序增量 (```PI```) 规划期间，开发团队为下一个 ```PI``` 规划功能（包括 4 次迭代，每次迭代两周，共 8 周）。 在 ```PI``` 计划中，团队将功能拆分为用户故事，并查看哪些功能适合 ```PI```。 计划的用户故事将被分配故事点（例如，以人天衡量），故事将被放入迭代中。 此计划阶段会产生团队应在 ```PI``` 中遵循的计划。 初级 ```SAFe``` 从业者可能会犯错误，例如低估完成用户故事所需的工作。 但这是一个自我纠正的问题。 当团队和个人发展起来时，他们会更好地估计所需的工作量，计划也会变得更加扎实。 团队和开发人员了解到他们必须让所有工作可见。 例如，预留时间学习新事物，如编程语言或框架，预留时间进行重构。 保持计划的进度，有时甚至提前完成工作，这让人非常满意。 这会让你觉得自己是一名真正的专业人士，并且会提升自尊。

## 定义完成原则

> 对于用户故事和功能，定义完成的含义。

在最佳情况下，开发团队对声明完成用户故事或功能所需的内容有共同的理解。 当对完成有一个共同的定义时，每个开发团队都可以确保一致的结果和质量。

在考虑用户故事时，至少可以为已完成的用户故事定义以下要求：

- 源代码提交到源代码存储库
- 源代码已审核
- 执行静态代码分析（无阻塞/关键/主要问题）
- 单元测试覆盖率至少为 ```X%```
- ```CI/CD``` 流水线正在通过
- 无第三方软件漏洞

产品所有者 (```PO```) 在团队中的角色是接受已完成的用户故事。 上面提到的一些要求可以自动检查。 例如，静态代码分析应该是每个 ```CI/CD``` 流水线的一部分，还可以自动检查单元测试覆盖率。 如果静态代码分析没有通过或者单元测试覆盖率不合格，```CI/CD``` 流水线就没有通过。

在考虑功能时，应该定义一些额外的完成度要求，因为功能可以交付给客户。 以下是已完成功能的一些要求列表：

- 架构设计文档更新
- 添加/更新集成测试
- 如果需要，添加/更新端到端测试
- 非功能测试完成
- 用户文档准备就绪
- 完成威胁建模，并实施威胁对策（安全功能）

为了完成所有必要的完成要求，开发团队可以使用工具来帮助他们记住需要完成的工作。 例如，当在 ```Jira``` 等工具中创建新的用户故事时，可以克隆现有的原型故事（或使用模板）。 原型或模板故事应该包含在批准用户故事之前必须完成的任务。

## 你为别人写代码的原则
> 你为其他人和未来的自己编写代码。

单独使用软件工作的情况相对较少。 你无法预测未来会发生什么。 可能有其他人负责你曾经编写的代码。 在某些情况下，你使用某些代码工作了一段时间，然后，也许几年后，需要返回到该代码。 出于这些原因，编写清晰的代码，以便将来他人和你自己易于阅读和理解是必不可少的。 请记住，代码不仅是为计算机编写的，也是为人编写的。 人们应该能够轻松阅读和理解代码。 请记住，在最好的情况下，代码读起来就像优美的散文！

## 避免技术债务原则

避免技术债务的最常见做法如下：

- 架构团队设计高层架构（每个团队在架构团队中应该有一名代表，通常是团队的技术负责人）
- 开发团队应该先进行面向对象的设计，然后再进行实现
- 在相关高级和初级开发人员参与的团队中进行面向对象的设计
- 不要立即使用最新的第三方软件，而是使用在市场上有一定地位的成熟的第三方软件
- 设计用于用另一个第 3 方组件轻松替换第 3 方软件组件。
- 可扩展性设计（用于未来负载）
- 为扩展而设计：新功能放在新类中而不是修改现有类
- 利用插件架构（创建插件以在以后添加新功能的可能性）
- 为重构预留时间

技术债务的主要原因如下：

- 使用利基技术或不成熟的全新技术
- 不使软件可扩展以满足未来的处理需求
- 当替换第 3 方软件组件不是相对容易时（例如，使用自定义 ```SQL``` 语法不允许更改数据库，不使用第 3 方库的适配器模式）
- 不审查架构
- 在开始编码之前不做任何面向对象的设计
- 在 ```OOD``` 阶段没有吸引足够资深的开发人员
- 不理解和使用相关的设计原则和模式
  - 不针对接口编程
  - 不容易更改依赖项（缺少 ```DI```）
  - 没有立面
- 不审查代码更改
- 没有为重构预留时间
- 工作量估计太小
- 来自管理层的时间压力
- 管理层不理解重构的价值
- 将重构推迟到永远不会到来的时间点
- 忘记重构（至少将需要的重构工作项存储在源代码存储库中的 ```TODO.MD``` 文件中）
- 没有单元测试，更难重构
- 重复代码
- 不执行童子军规则
- 懒惰（使用首先想到的或不断尝试找到最简单和最快的做事方式）

## 软件组件文档原则
> 需要记录每个软件组件。 记录背后的主要思想是快速让新人加入开发工作。

为软件组件设置一个开发环境是有据可查的，并且尽可能简单，这一点至关重要。 另一件重要的事情是让人们容易理解软件组件试图解决的问题领域。 此外，应记录软件组件的面向对象设计。

软件组件文档应位于源代码所在的同一源代码存储库中。 推荐的方式是使用源码仓库根目录下的 ```README.MD``` 文件来做 ```Markdown``` 格式的文档。 你可以将文档拆分为多个文件，并将其他文件存储在源代码存储库的 ```docs``` 目录中。

下面是一个示例目录，可以在记录软件组件时使用：

- 软件组件及其用途的简短描述
- 功能列表
- ```OOD```图描述了不同的子域和每个子域中的类
  - 设计说明（如果需要）
- ```API``` 文档（用于库）
- 实施相关文档
  - 错误处理机制
  - 使用的特殊算法
  - 性能考虑
- 搭建开发环境的说明
  - 设置开发环境的最简单方法是使用开发容器，这是 Visual Studio Code 编辑器支持的概念。 使用开发容器的好处是不用在本地安装开发工具，也不存在使用错误版本的开发工具的风险
- 在本地构建软件的说明
- 在本地运行单元测试的说明
- 在本地运行集成测试的说明
- 部署到测试环境的说明
- 配置
  - 环境变量
  - 配置文件
  - 秘钥

## 代码审查原则

> 在代码审查中，关注机器无法为你找到的问题。

在审查代码之前，应该执行静态代码分析以找出机器可以找到的任何问题。 实际的代码审查应该关注静态代码分析器无法发现的问题。 你无法查看自己的代码。 至少有一名审稿人应担任高级或领导职务。 代码审查中需要关注的事项将在后续部分中介绍。

### 专注于面向对象设计
在开始编码之前，建议设计软件：定义子域、所需的接口和类。 这个初始设计阶段的产品应该提交给源代码存储库，并在开始编码之前进行审查。 这样，更容易及早纠正设计缺陷。 在后期修复设计缺陷可能需要付出大量努力，甚至需要重写现有代码。 至少应有一名高级开发人员参与设计。

如果在审查中遇到设计缺陷或缺陷，但没有时间立即修复。 一个或多个重构用户故事应该添加到团队的积压工作中。

### 注重正确和统一的命名
静态代码分析工具只能部分完成的一件事是确保对事物（如类、函数和变量）进行正确和统一的命名。 命名是代码审查中应重点关注的地方。 重命名是一项非常直接且快速的重构任务，可以由现代 ```IDE``` 自动执行。

### 不要专注于过早的优化
不要专注于常规代码审查中的优化。 优化通常在代码准备好并首先测量性能后根据需要执行。 仅当你正在审查的提交专门用于优化某些内容时，才关注与优化相关的问题。

### 检测可能的恶意代码

代码审查者必须验证提交的代码不包含恶意代码。

## 统一代码格式原则

> 在软件开发团队中，你必须决定格式化源代码的通用规则。

一致的代码格式非常重要，因为如果团队成员有不同的源代码格式规则，一个团队成员对文件的小改动可能会使用他/她的格式规则重新格式化整个文件，这可能会导致另一个开发人员面临重大的合并冲突，从而减慢速度 开发过程。 始终就通用源代码格式规则达成一致，最好使用像 ```Prettier``` 这样的工具来执行格式规则。 如果没有可用的自动格式化工具，你可以为团队成员使用的 ```IDE``` 创建源代码格式化规则，并将这些规则存储在源代码存储库中。

## 高并发开发原则

> 每个团队成员都可以使用一些代码。 没有人应该为别人的工作完成而等待很长时间。

当不同的人修改不同的源代码文件时，可以实现并发开发。 当几个人需要更改同一个文件时，可能会导致合并冲突。 这些合并冲突会导致额外的工作，因为它们通常必须手动解决。 这种手动工作可能很慢，而且容易出错。 最好的办法是尽可能避免合并冲突。 这可以通过以下部分中描述的方式实现。

### 专用微服务和微库

微服务本质上很小，可以将微服务的责任分配给单个团队成员。 该团队成员可以全速处理微服务，并且可以放心，没有其他人在修改代码库。 图书馆也是如此。 你应该创建小型微型图书馆（= 具有单一职责的图书馆）并将开发微型图书馆的责任分配给一个人。

### 专用域
有时不可能将单个微服务或库分配给单个开发人员。 可能是微服务或库比较大，拆分成多个微服务或库不可行。 在这些情况下，应该通过领域驱动设计将微服务或库划分为多个子域。 每个源代码目录都反映了一个不同的子域。 然后可以将单个子域的责任分配给一个人。 子域的分配不应该是固定的，而是可以而且应该随着时间的推移而改变。 为了分配不同领域的知识，建议在团队成员之间轮换职责。 假设你有一个由三名开发人员组成的团队，正在开发一个由三个子域组成的数据导出器微服务：输入、转换器和输出。 团队可以通过将单个域的责任分配给单个开发人员来实现微服务。 现在，所有开发人员都可以高度独立地并发地进行实施。 在早期阶段，他们必须定义不同子域之间的接口。

将来，当开发新功能时，团队成员可以负责其他领域，在团队中传播有关微服务的知识。

### 遵循开闭原则

有时你可能会遇到这样的情况，即单个子域太大以至于你需要多个开发人员。 当然，这应该是比较少见的情况。 当多个开发人员修改属于同一子域（即同一目录）的源代码文件时，可能会出现合并冲突。 就是这种情况，尤其是当现有的源代码文件被修改时。 但是当开发人员遵循开闭原则时，他们不应该改变现有的类（源代码文件），而是在新类（源代码文件）中实现新的功能。 使用开闭原则使开发人员能够更多地并发开发，因为他们主要使用不同的源代码文件，从而使合并冲突很少或至少不那么频繁。

## 结对编程原则
> 结对编程有助于通过更好的设计、更少的技术债务、更好的测试和更少的错误来生产质量更好的软件。

结对编程是一些开发人员喜欢的，而其他开发人员讨厌的。 所以它不是一个放之四海而皆准的解决方案。 它也不是接受或离开它。 你可以拥有一个团队，其中一些开发人员成对编程，而其他开发人员则没有。 此外，人们对结对编程的看法可能存在偏见。 或许，他们从来没有做过结对编程，那他们怎么知道自己喜不喜欢呢？ 的确，选择合适的合作伙伴进行配对可能意义重大。 有些对比其他对具有更好的化学反应。

结对编程只会增加开发成本吗？ 结对编程带来什么好处？

我认为结对编程很有价值，尤其是在初级开发人员与高级开发人员结对的情况下，这样初级开发人员的入职速度要快得多。 他可以"向最好的人学习"。 结对编程可以改进软件设计，因为设计总是至少有两个人的观点。 可以更容易地发现错误，并且通常在较早的阶段（四只眼睛与两只眼睛相比）。 因此，即使结对编程会增加一些成本，它通常也会产生质量更好的软件：更好的设计、更少的技术债务、更好的测试和更少的错误。

## 明确定义的开发团队角色原则

> 软件开发团队应该为每个团队成员定义明确的角色。

如果每个人都在做所有事情，或者如果期望任何人都可以做任何事情，那么软件开发团队就不会发挥最佳作用。 没有人是万事通。 当一个团队有针对不同任务的专家时，它会取得最好的结果。 团队成员需要有他们喜欢工作的重点领域以及他们可以擅长的领域。 当你是某个领域的专家时，你可以更快、更好地完成属于该领域的任务。

以下是开发团队所需角色的列表：

- 产品负责人 (```PO```)
- ```Scrum``` 大师 (```SM```)
- 软件开发人员（初级/高级/主管）
- 测试自动化开发人员
- 开发运维工程师
- ```UI``` 设计师（如果团队开发 UI 软件组件）

让我们在以下部分详细讨论每个角色的职责。

### 产品拥有者
产品负责人（```PO```）充当开发团队和业务之间的接口，通常意味着产品管理。 ```PO``` 负责定义用户故事并与团队一起确定团队待办事项的优先级。 ```PO``` 角色通常不是全职角色。

### ```Scrum``` 大师

```Scrum Master``` (```SM```) 是开发团队的仆人领导者和教练。 ```Scrum``` 主管确保遵循相关的敏捷实践和敏捷过程。 他们对团队进行敏捷实践培训。 如果团队有直线经理，直线经理可以担任 ```scrum master```，但任何团队成员都可以担任 ```scrum master```。

### 软件开发人员

软件开发人员负责设计、实施和测试软件（包括单元测试，在大多数情况下还包括集成测试）。 软件开发人员通常专注于一种或两种编程语言和几种技术框架。 通常，软件开发人员分为以下几类：

- 后端开发人员
- 前端开发人员
- 全栈开发人员
- 移动端开发人员
- 嵌入式开发人员

后端开发人员开发在后端运行的微服务，例如 ```API```。 前端开发人员开发 ```Web``` 客户端。 通常，前端开发人员使用 ```JavaScript``` 或 ```TypeScript```、```React/Angular/Vue```、```HTML``` 和 ```CSS```。 全栈开发人员是能够开发后端微服务和前端客户端的后端和前端开发人员的组合。 移动开发人员为手机和平板电脑等移动设备开发软件。

一个团队应该有不同资历级别的软件开发人员。 每个团队都应该有一位在所用技术和领域中具有最佳经验的首席开发人员。 首席开发人员通常属于由系统架构师领导的虚拟架构团队。 拥有一个只有初级开发人员或高级开发人员的团队是没有意义的。 这个想法是将技能和知识从高级开发人员转移到初级开发人员。 反之亦然。 初级开发人员可以了解高级开发人员所缺少的一些最新技术和实践。 所以总的来说，最好的团队是由初级和高级开发人员组成的团队。

### 测试自动化开发人员

测试自动化开发人员负责开发不同类型的自动化测试。 通常，测试自动化开发人员开发集成、```E2E``` 和自动化非功能测试。 测试自动化开发人员必须精通至少一种用于开发自动化测试的编程语言，例如 ```Python```。 测试自动化开发人员必须精通 ```BDD``` 和一些常见的测试框架，例如 ```Cucumber-JVM``` 或 ```Behave```。 了解一些测试工具（如 ```Apache JMeter```）是值得赞赏的。 测试自动化开发人员还可以开发内部测试工具，如界面模拟器和数据生成器。 测试自动化开发人员应该组成一个虚拟团队，以促进 ```E2E``` 和自动化非功能测试的开发。

### 开发运维工程师

```DevOps``` 工程师充当软件开发团队和软件操作之间的接口。 ```DevOps``` 工程师通常为微服务创建 ```CI/CD``` 管道，并编写基础架构和部署相关代码。 ```DevOps``` 工程师还定义了警报规则和指标可视化仪表板，可在监控生产中的软件时使用。 ```DevOps``` 工程师帮助运维人员监控生产中的软件。 他们可以帮助解决技术支持组织无法解决的问题。 ```DevOps``` 工程师知道部署软件的环境（=基础设施和平台），这意味着至少需要了解一个云提供商（```AWS```/```Azure```/谷歌云等），也许还需要 ```Kubernetes``` 的基本知识。 ```DevOps``` 工程师应该组成一个虚拟团队来促进指定与 ```DevOps``` 相关的实践和指南。

### ```UI``` 设计师
```UI``` 设计师负责根据更高级别的 ```UX```/```UI``` 设计/线框设计最终的 ```UI```。 ```UI``` 设计师还将对软件进行可用性测试。